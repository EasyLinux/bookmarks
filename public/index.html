<!DOCTYPE html>
<html>
    <head>
        <title>Bookmarks</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.3.4/vue.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/1.3.4/vue-resource.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.4/js.cookie.min.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css">

        <style type="text/css">
            #app {
                padding-top: 20px;
                font-family: 'Avenir', Helvetica, Arial, sans-serif;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
                color: #2c3e50;
            }
            .bookmarks .card {
                margin-bottom: 20px;
            }
            .bookmarks .card-header h4 {
                margin-bottom: 0;
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                font-size: 1rem;
            }
            .bookmarks .card-header small {
                display: block;
                text-overflow: ellipsis;
                white-space: nowrap;
                overflow: hidden;
                font-size: 0.9rem;
            }
            .bookmarks .card-block {
                font-size: 0.9rem;
            }
            .bookmarks .card-text {
                font-size: 0.8rem;
                line-height: 1.6em;
                max-height: 4.8em;
                overflow: hidden;
                text-overflow: ellipsis;
                word-wrap: break-word;
            }
        </style>
    </head>

    <body>
        <div id="app">
            <div class="container-fluid" v-if="!authenticated">
                <div class="row justify-content-md-center">
                    <div class="col col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Secret token" v-on:keyup.enter="login()" v-model="secret" autofocus>
                            <span class="input-group-btn">
                                <button class="btn btn-success" type="button" v-on:click.once="login()">Login</button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid" v-if="authenticated">
                <div class="row">
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Search bookmarks" v-model="search" v-bind:value="search"autofocus>
                    </div>
                </div>

                <hr />

                <div class="row bookmarks">
                    <div class="col">
                        <div class="card" v-for="(bookmark, index) in bookmarks">
                            <div class="card-header">
                                <h4><a v-bind:href="bookmark.URL">{{ bookmark.Title }}</a></h4>
                                <small class="text-success">{{ bookmark.URL }}</small>
                            </div>
                            <div class="card-block">
                                <p><em>{{ bookmark.CreatedAt }}</em> &mdash; <a href v-on:click.prevent="deleteBookmark(bookmark, index)">Delete</a></p>
                                <p class="card-text" v-html="bookmark.Content"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            function getParamValuesByName (querystring) {
                var qstring = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                for (var i = 0; i < qstring.length; i++) {
                    var urlparam = qstring[i].split('=');
                    if (urlparam[0] == querystring) {
                        return urlparam[1];
                    }
                }
            };

            new Vue({
                el: '#app',
                data: {
                    search: "",
                    authenticated: false,
                    secret: undefined,
                    bookmarks: [],
                },
                created: function() {
                    this.authenticated = Cookies.get('secret') !== undefined;
                    this.search = getParamValuesByName('search');
                },
                methods: {
                    login: function() {
                        Cookies.set('secret', this.secret, { expires: 365 });
                        this.authenticated = true;
                    },
                    logout: function() {
                        Cookies.remove('secret');
                        this.authenticated = false;
                    },
                    fetchBookmarks: _.debounce(function() {
                        if (!this.authenticated) {
                            return;
                        }
                        this.$http.get('bookmarks', {params:{search:this.search}}).then(function(response) {
                            this.bookmarks = response.body;
                        }, function (response) {
                            if (response.status === 401) {
                                this.logout();
                            }
                        });
                    }, 500),
                    deleteBookmark: function(bookmark, index) {
                        if (window.confirm("Are you sure you want to delete this bookmark?")) {
                            this.$http.delete('bookmarks/'+bookmark.ID).then(function (response) {
                                this.bookmarks.splice(index, 1);
                            });
                        }
                    },
                },
                watch: {
                    search: function (value) {
                        this.fetchBookmarks();
                    },
                    authenticated: function (value) {
                        if (value) {
                            this.fetchBookmarks();
                        } else {
                            this.bookmarks = [];
                        }
                    }
                }
            });
        </script>
    </body>
</html>
