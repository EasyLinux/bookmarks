<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bookmarks</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.0/css/bulma.min.css">
    <script src="https://unpkg.com/vue/dist/vue.min.js"></script>
    <script src="https://unpkg.com/vue-router/dist/vue-router.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>
  <body>
    <div id="app">
      <section class="hero is-bold" :class="color">
        <div class="hero-body">
          <div class="container">
            <h1 class="title">{{ title }}</h1>
            <h2 class="subtitle">{{ subtitle }}</h2>
          </div>
        </div>
        <div class="hero-foot">
          <nav class="tabs is-boxed is-right">
            <div class="container">
              <ul>
                <li><router-link exact active-class="is-active" tag="li" to="/"><a>Read It Later</a></router-link></li>
                <li><router-link exact active-class="is-active" tag="li" to="/archive"><a>Archive</a></router-link></li>
                <li><router-link exact active-class="is-active" tag="li" to="/feeds"><a>Feeds</a></router-link></li>
              </ul>
            </div>
          </nav>
        </div>
      </section>

      <section class="section">
        <div class="container">
          <router-view></router-view>
        </div>
      </section>

      <footer class="footer">
        <div class="container">
          <div class="content has-text-centered is-size-7">
            <p>Made with love by CasaDiRocco</p>
            <p><a @click.prevent="open=true">bookmarklet</a></p>
          </div>
        </div>
      </footer>

      <div class="modal" :class="{'is-active':open}">
        <div class="modal-background"></div>
        <div class="modal-content">
          <textarea class="textarea">javascript:(function(){window.location = '{{ baseurl }}/bookmarks/save?url='+encodeURIComponent(location.href)+'&title='+encodeURIComponent(document.title);})();</textarea>
        </div>
        <button class="modal-close is-large" aria-label="close" @click.prevent="open=false"></button>
      </div>
    </div>

    <script type="text/x-template" id="feeds-list">
      <div>
        <div class="block control is-expanded">
          <div class="select is-fullwidth">
            <select v-model="selected" @change="onChange">
              <option value="">All feeds</option>
              <option v-for="feed in feeds" :key="feed.ID" :value="feed.ID">{{ feed.Title }}</option>
            </select>
          </div>
        </div>
        <div class="block" v-for="item in items" :key="item.ID">
          <p class="has-text-weight-bold">{{ item.Title }}</p>
          <p class="is-size-7"><a :href="item.URL">{{ item.URL }}</a></p>
          <p class="content">{{ item.Content|excerpt }}</p>
          <p class="block has-text-right">
            <a @click.prevent="onRemoveClicked(item)" class="button is-small is-danger is-outlined">Remove</a>
            <a @click.prevent="onReadItLaterClicked(item)" class="button is-small is-primary">Read it later</a>
          </p>
        </div>
      <div>
    </script>

    <script type="text/x-template" id="bookmarks-list">
      <div>
        <div class="block control">
          <input class="input" type="search" placeholder="Search" v-model="q" autofocus @search="onSearch">
        </div>
        <div class="block" v-for="bookmark in bookmarks" :key="bookmark.ID">
          <p class="has-text-weight-bold">{{ bookmark.Title }}</p>
          <p class="is-size-7"><a :href="bookmark.URL">{{ bookmark.URL }}</a></p>
          <p class="content">{{ bookmark.Content|excerpt }}</p>
          <p class="block has-text-right">
            <a @click.prevent="onRemoveClicked(bookmark)" class="button is-small is-danger is-outlined">Remove</a>
            <a @click.prevent="onReadItLaterClicked(bookmark)" class="button is-small is-primary" v-if="bookmark.Archived">Read it later</a>
            <a @click.prevent="onArchiveClicked(bookmark)" class="button is-small is-dark" v-else="bookmark.Archived">Archive</a>
          </p>
        </div>
      </div>
    </script>

    <script>
      var BookmarksList = Vue.extend({
        template: '#bookmarks-list',
        data: function () {
          return {
            bookmarks: [],
            q: "",
          };
        },
        filters: {
          excerpt: function (value) {
            if (!value) {
              return "No content";
            }
            return value.toString().substring(0, 500) + "...";
          },
        },
        methods: {
          onSearch: function(event) {
            this.$router.push({query: {q: this.q}})
          },
          onReadItLaterClicked: function (bookmark) {
            var self = this;
            axios.post("/bookmarks/"+bookmark.ID+"/readitlater").then(function (response) {
              self.bookmarks.splice(self.bookmarks.indexOf(bookmark), 1);
            });
          },
          onArchiveClicked: function (bookmark) {
            var self = this;
            axios.post("/bookmarks/"+bookmark.ID+"/archive").then(function (response) {
              self.bookmarks.splice(self.bookmarks.indexOf(bookmark), 1);
            });
          },
          onRemoveClicked: function (bookmark) {
            var self = this;
            axios.delete("/bookmarks/"+bookmark.ID).then(function (response) {
              self.bookmarks.splice(self.bookmarks.indexOf(bookmark), 1);
            });
          },
          fetchBookmarks: function () {
            var payload = {}, self = this;
            if (this.$route.meta.archived) {
              payload.archived = "true";
            }
            if (this.q != "") {
              payload.q = this.q;
            }
            axios.get("/bookmarks", {params:payload}).then(function (response) {
              self.bookmarks = response.data;
            });
          }
        },
        beforeRouteUpdate (to, from, next) {
          next();
          this.fetchBookmarks();
        },
        beforeRouteEnter: function (to, from, next) {
          next(function(vm) {
            vm.fetchBookmarks();
          });
        },
      });

      var Feeds = {
        template: "#feeds-list",
        data: function () {
          return {
            feeds: [],
            items: [],
            selected: "",
          };
        },
        filters: {
          excerpt: function (value) {
            if (!value) {
              return "No content";
            }
            return value.toString().substring(0, 500) + "...";
          },
        },
        methods: {
          onChange: function(event) {
            this.$router.push({query: {feed: this.selected}});
          },
          onReadItLaterClicked: function (item) {
            var self = this;
            axios.post("/items/"+item.ID+"/readitlater").then(function (response) {
              self.items.splice(self.items.indexOf(item), 1);
            });
          },
          onRemoveClicked: function (item) {
            var self = this;
            axios.delete("/items/"+item.ID).then(function (response) {
              self.items.splice(self.items.indexOf(item), 1);
            });
          },
          fetchFeeds: function () {
            var payload = {}, self = this;
            if (this.selected != "") {
              payload.feed = this.selected;
            }
            axios.get("/items", {params:payload}).then(function (response) {
              self.items = response.data;
            });
            axios.get("/feeds").then(function (response) {
              self.feeds = response.data;
            });
          }
        },
        beforeRouteUpdate (to, from, next) {
          next();
          this.fetchFeeds();
        },
        beforeRouteEnter: function (to, from, next) {
          next(function(vm) {
            vm.fetchFeeds();
          });
        },
      };

      new Vue({
        el: "#app",
        router: new VueRouter({
          routes: [
            {
              path: "/",
              component: BookmarksList,
              meta: {
                title: "Read it later",
                subtitle: "All articles you recently saved",
                archived: false,
                color: "is-primary"
              }
            },
            {
              path: "/archive",
              component: BookmarksList,
              meta: {
                title: "Archive",
                subtitle: "All articles you archived",
                archived: true,
                color: "is-dark"
              }
            },
            {
              path: "/feeds",
              component: Feeds,
              meta: {
                title: "Feeds",
                subtitle: "All your rss and atom feeds",
                color: "is-warning"
              }
            },
          ],
        }),
        data: function () {
          return {
            open: false,
          };
        },
        computed: {
          baseurl: function () {
            return location.protocol+"//"+location.host;
          },
          title: function () {
            return this.$route.meta.title;
          },
          subtitle: function () {
            return this.$route.meta.subtitle;
          },
          color: function () {
            return this.$route.meta.color;
          },
        },
      });
    </script>
  </body>
</html>
